"use strict";(self.webpackChunkleix_wang_website=self.webpackChunkleix_wang_website||[]).push([[301],{3905:function(e,n,r){r.d(n,{Zo:function(){return d},kt:function(){return m}});var s=r(7294);function t(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function a(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);n&&(s=s.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,s)}return r}function i(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?a(Object(r),!0).forEach((function(n){t(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function l(e,n){if(null==e)return{};var r,s,t=function(e,n){if(null==e)return{};var r,s,t={},a=Object.keys(e);for(s=0;s<a.length;s++)r=a[s],n.indexOf(r)>=0||(t[r]=e[r]);return t}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(s=0;s<a.length;s++)r=a[s],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(t[r]=e[r])}return t}var o=s.createContext({}),u=function(e){var n=s.useContext(o),r=n;return e&&(r="function"==typeof e?e(n):i(i({},n),e)),r},d=function(e){var n=u(e.components);return s.createElement(o.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return s.createElement(s.Fragment,{},n)}},c=s.forwardRef((function(e,n){var r=e.components,t=e.mdxType,a=e.originalType,o=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=u(r),m=t,g=c["".concat(o,".").concat(m)]||c[m]||p[m]||a;return r?s.createElement(g,i(i({ref:n},d),{},{components:r})):s.createElement(g,i({ref:n},d))}));function m(e,n){var r=arguments,t=n&&n.mdxType;if("string"==typeof e||t){var a=r.length,i=new Array(a);i[0]=c;var l={};for(var o in n)hasOwnProperty.call(n,o)&&(l[o]=n[o]);l.originalType=e,l.mdxType="string"==typeof e?e:t,i[1]=l;for(var u=2;u<a;u++)i[u]=r[u];return s.createElement.apply(null,i)}return s.createElement.apply(null,r)}c.displayName="MDXCreateElement"},5178:function(e,n,r){r.r(n),r.d(n,{frontMatter:function(){return l},contentTitle:function(){return o},metadata:function(){return u},toc:function(){return d},default:function(){return c}});var s=r(7462),t=r(3366),a=(r(7294),r(3905)),i=["components"],l={sidebar_position:4},o="Session\u529f\u80fd\u5b9e\u73b0",u={unversionedId:"golang/session",id:"golang/session",title:"Session\u529f\u80fd\u5b9e\u73b0",description:"1.1\u4e1a\u52a1\u6d41\u7a0b\u56fe",source:"@site/docs/01.golang/04.session.md",sourceDirName:"01.golang",slug:"/golang/session",permalink:"/docs/golang/session",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Redis \u6570\u636e\u5e93",permalink:"/docs/golang/redis"},next:{title:"\u5fae\u670d\u52a1\uff08micro services\uff09",permalink:"/docs/golang/micro-server"}},d=[{value:"1.1\u4e1a\u52a1\u6d41\u7a0b\u56fe",id:"11\u4e1a\u52a1\u6d41\u7a0b\u56fe",children:[],level:2},{value:"1.2\u63a5\u53e3\u5b9a\u4e49",id:"12\u63a5\u53e3\u5b9a\u4e49",children:[],level:2},{value:"1.3\u5177\u4f53\u4e1a\u52a1\u5b9e\u73b0",id:"13\u5177\u4f53\u4e1a\u52a1\u5b9e\u73b0",children:[],level:2},{value:"2.\u7528\u6237\u4fe1\u606f\u5c55\u793a",id:"2\u7528\u6237\u4fe1\u606f\u5c55\u793a",children:[{value:"2.1\u4e1a\u52a1\u6d41\u7a0b\u56fe",id:"21\u4e1a\u52a1\u6d41\u7a0b\u56fe",children:[],level:3},{value:"2.2\u63a5\u53e3\u5b9a\u4e49",id:"22\u63a5\u53e3\u5b9a\u4e49",children:[],level:3}],level:2},{value:"2.3\u670d\u52a1\u7aef\u5b9e\u73b0",id:"23\u670d\u52a1\u7aef\u5b9e\u73b0",children:[],level:2},{value:"2.4web\u7aef\u5b9e\u73b0",id:"24web\u7aef\u5b9e\u73b0",children:[],level:2},{value:"3.1\u4e1a\u52a1\u6d41\u7a0b\u56fe",id:"31\u4e1a\u52a1\u6d41\u7a0b\u56fe",children:[],level:2},{value:"3.2\u63a5\u53e3\u5b9a\u4e49",id:"32\u63a5\u53e3\u5b9a\u4e49",children:[],level:2},{value:"3.3\u4e1a\u52a1\u5b9e\u73b0",id:"33\u4e1a\u52a1\u5b9e\u73b0",children:[],level:2},{value:"4.\u767b\u9646\u4e1a\u52a1\u5b9e\u73b0",id:"4\u767b\u9646\u4e1a\u52a1\u5b9e\u73b0",children:[{value:"4.1\u4e1a\u52a1\u6d41\u7a0b\u56fe",id:"41\u4e1a\u52a1\u6d41\u7a0b\u56fe",children:[],level:3},{value:"4.2\u63a5\u53e3\u5b9a\u4e49",id:"42\u63a5\u53e3\u5b9a\u4e49",children:[],level:3},{value:"4.3\u670d\u52a1\u7aef\u5b9e\u73b0",id:"43\u670d\u52a1\u7aef\u5b9e\u73b0",children:[],level:3},{value:"4.4web\u7aef\u5b9e\u73b0",id:"44web\u7aef\u5b9e\u73b0",children:[],level:3}],level:2},{value:"5.\u4e0a\u4f20\u7528\u6237\u5934\u50cf\u4e1a\u52a1",id:"5\u4e0a\u4f20\u7528\u6237\u5934\u50cf\u4e1a\u52a1",children:[{value:"5.1\u4e1a\u52a1\u6d41\u7a0b\u56fe",id:"51\u4e1a\u52a1\u6d41\u7a0b\u56fe",children:[],level:3},{value:"5.2\u63a5\u53e3\u5b9a\u4e49",id:"52\u63a5\u53e3\u5b9a\u4e49",children:[],level:3},{value:"5.3\u670d\u52a1\u7aef\u5b9e\u73b0",id:"53\u670d\u52a1\u7aef\u5b9e\u73b0",children:[],level:3},{value:"5.4web\u7aef\u5b9e\u73b0",id:"54web\u7aef\u5b9e\u73b0",children:[],level:3}],level:2},{value:"6.\u66f4\u65b0\u7528\u6237\u540d",id:"6\u66f4\u65b0\u7528\u6237\u540d",children:[{value:"6.1\u4e1a\u52a1\u6d41\u7a0b\u56fe",id:"61\u4e1a\u52a1\u6d41\u7a0b\u56fe",children:[],level:3},{value:"6.2\u63a5\u53e3\u5b9a\u4e49",id:"62\u63a5\u53e3\u5b9a\u4e49",children:[],level:3},{value:"6.3\u670d\u52a1\u7aef\u5b9e\u73b0",id:"63\u670d\u52a1\u7aef\u5b9e\u73b0",children:[],level:3},{value:"6.4web\u7aef\u5b9e\u73b0",id:"64web\u7aef\u5b9e\u73b0",children:[],level:3}],level:2},{value:"7.\u68c0\u67e5\u7528\u6237\u5b9e\u540d\u8ba4\u8bc1",id:"7\u68c0\u67e5\u7528\u6237\u5b9e\u540d\u8ba4\u8bc1",children:[{value:"7.1\u4e1a\u52a1\u6d41\u7a0b\u56fe",id:"71\u4e1a\u52a1\u6d41\u7a0b\u56fe",children:[],level:3},{value:"7.2\u63a5\u53e3\u5b9a\u4e49",id:"72\u63a5\u53e3\u5b9a\u4e49",children:[],level:3},{value:"7.3\u670d\u52a1\u7aef\u5b9e\u73b0",id:"73\u670d\u52a1\u7aef\u5b9e\u73b0",children:[],level:3},{value:"7.4web\u7aef\u5b9e\u73b0",id:"74web\u7aef\u5b9e\u73b0",children:[],level:3}],level:2},{value:"8.\u66f4\u65b0\u7528\u6237\u5b9e\u540d\u8ba4\u8bc1",id:"8\u66f4\u65b0\u7528\u6237\u5b9e\u540d\u8ba4\u8bc1",children:[{value:"8.1\u4e1a\u52a1\u6d41\u7a0b\u56fe",id:"81\u4e1a\u52a1\u6d41\u7a0b\u56fe",children:[],level:3},{value:"8.2\u63a5\u53e3\u5b9a\u4e49",id:"82\u63a5\u53e3\u5b9a\u4e49",children:[],level:3},{value:"8.3\u670d\u52a1\u7aef\u5b9e\u73b0",id:"83\u670d\u52a1\u7aef\u5b9e\u73b0",children:[],level:3},{value:"8.4web\u7aef\u5b9e\u73b0",id:"84web\u7aef\u5b9e\u73b0",children:[],level:3}],level:2},{value:"9 \u83b7\u53d6\u5f53\u524d\u7528\u6237\u5df2\u53d1\u5e03\u623f\u6e90\u4fe1\u606f",id:"9-\u83b7\u53d6\u5f53\u524d\u7528\u6237\u5df2\u53d1\u5e03\u623f\u6e90\u4fe1\u606f",children:[{value:"\u521b\u5efa\u547d\u4ee4",id:"\u521b\u5efa\u547d\u4ee4",children:[],level:3},{value:"\u6d41\u7a0b\u4e0e\u63a5\u53e3",id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3",children:[],level:3},{value:"\u670d\u52a1\u7aef\u5b9e\u73b0",id:"\u670d\u52a1\u7aef\u5b9e\u73b0",children:[],level:3},{value:"web\u7aef\u5b9e\u73b0",id:"web\u7aef\u5b9e\u73b0",children:[],level:3}],level:2},{value:"10 \u53d1\u5e03\u623f\u6e90\u4fe1\u606f",id:"10-\u53d1\u5e03\u623f\u6e90\u4fe1\u606f",children:[{value:"\u521b\u5efa\u547d\u4ee4",id:"\u521b\u5efa\u547d\u4ee4-1",children:[],level:3},{value:"\u6d41\u7a0b\u4e0e\u63a5\u53e3",id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-1",children:[],level:3},{value:"\u670d\u52a1\u7aef\u5b9e\u73b0",id:"\u670d\u52a1\u7aef\u5b9e\u73b0-1",children:[],level:3},{value:"web\u7aef\u5b9e\u73b0",id:"web\u7aef\u5b9e\u73b0-1",children:[],level:3}],level:2},{value:"11 \u4e0a\u4f20\u623f\u5c4b\u56fe\u7247",id:"11-\u4e0a\u4f20\u623f\u5c4b\u56fe\u7247",children:[{value:"\u521b\u5efa\u547d\u4ee4",id:"\u521b\u5efa\u547d\u4ee4-2",children:[],level:3},{value:"\u6d41\u7a0b\u4e0e\u63a5\u53e3",id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-2",children:[],level:3},{value:"\u670d\u52a1\u7aef\u5b9e\u73b0",id:"\u670d\u52a1\u7aef\u5b9e\u73b0-2",children:[],level:3},{value:"web\u7aef\u5b9e\u73b0",id:"web\u7aef\u5b9e\u73b0-2",children:[],level:3}],level:2},{value:"12 \u83b7\u53d6\u623f\u6e90\u8be6\u7ec6\u4fe1\u606f",id:"12-\u83b7\u53d6\u623f\u6e90\u8be6\u7ec6\u4fe1\u606f",children:[{value:"\u521b\u5efa\u547d\u4ee4",id:"\u521b\u5efa\u547d\u4ee4-3",children:[],level:3},{value:"\u6d41\u7a0b\u4e0e\u63a5\u53e3",id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-3",children:[],level:3},{value:"\u670d\u52a1\u7aef\u5b9e\u73b0",id:"\u670d\u52a1\u7aef\u5b9e\u73b0-3",children:[],level:3},{value:"web\u7aef\u5b9e\u73b0",id:"web\u7aef\u5b9e\u73b0-3",children:[],level:3}],level:2},{value:"13 \u83b7\u53d6\u9996\u9875\u52a8\u753b\u56fe\u7247",id:"13-\u83b7\u53d6\u9996\u9875\u52a8\u753b\u56fe\u7247",children:[{value:"\u521b\u5efa\u547d\u4ee4",id:"\u521b\u5efa\u547d\u4ee4-4",children:[],level:3},{value:"\u6d41\u7a0b\u4e0e\u63a5\u53e3",id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-4",children:[],level:3}],level:2},{value:"14 \u641c\u7d22\u623f\u6e90",id:"14-\u641c\u7d22\u623f\u6e90",children:[{value:"\u521b\u5efa\u547d\u4ee4",id:"\u521b\u5efa\u547d\u4ee4-5",children:[],level:3},{value:"\u6d41\u7a0b\u4e0e\u63a5\u53e3",id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-5",children:[],level:3}],level:2},{value:"15 \u53d1\u5e03\u8ba2\u5355",id:"15-\u53d1\u5e03\u8ba2\u5355",children:[{value:"\u521b\u5efa\u547d\u4ee4",id:"\u521b\u5efa\u547d\u4ee4-6",children:[],level:3},{value:"\u6d41\u7a0b\u4e0e\u63a5\u53e3",id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-6",children:[],level:3}],level:2},{value:"16 \u8bf7\u6c42\u67e5\u770b\u623f\u4e1c/\u79df\u5ba2\u8ba2\u5355\u4fe1\u606f",id:"16-\u8bf7\u6c42\u67e5\u770b\u623f\u4e1c\u79df\u5ba2\u8ba2\u5355\u4fe1\u606f",children:[{value:"\u521b\u5efa\u547d\u4ee4",id:"\u521b\u5efa\u547d\u4ee4-7",children:[],level:3},{value:"\u6d41\u7a0b\u4e0e\u63a5\u53e3",id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-7",children:[],level:3}],level:2},{value:"17 \u623f\u4e1c\u540c\u610f/\u62d2\u7edd\u8ba2\u5355",id:"17-\u623f\u4e1c\u540c\u610f\u62d2\u7edd\u8ba2\u5355",children:[{value:"\u521b\u5efa\u547d\u4ee4",id:"\u521b\u5efa\u547d\u4ee4-8",children:[],level:3},{value:"\u6d41\u7a0b\u4e0e\u63a5\u53e3",id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-8",children:[],level:3}],level:2},{value:"18 \u7528\u6237\u8bc4\u4ef7\u8ba2\u5355\u4fe1\u606f",id:"18-\u7528\u6237\u8bc4\u4ef7\u8ba2\u5355\u4fe1\u606f",children:[{value:"\u521b\u5efa\u547d\u4ee4",id:"\u521b\u5efa\u547d\u4ee4-9",children:[],level:3},{value:"\u6d41\u7a0b\u4e0e\u63a5\u53e3",id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-9",children:[],level:3}],level:2}],p={toc:d};function c(e){var n=e.components,l=(0,t.Z)(e,i);return(0,a.kt)("wrapper",(0,s.Z)({},p,l,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"session\u529f\u80fd\u5b9e\u73b0"},"Session\u529f\u80fd\u5b9e\u73b0"),(0,a.kt)("h2",{id:"11\u4e1a\u52a1\u6d41\u7a0b\u56fe"},"1.1\u4e1a\u52a1\u6d41\u7a0b\u56fe"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"111",src:r(9538).Z})),(0,a.kt)("h2",{id:"12\u63a5\u53e3\u5b9a\u4e49"},"1.2\u63a5\u53e3\u5b9a\u4e49"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: GET\nurl:api/v1.0/session\ndata:no input data\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n    "errno": "0",\n    "errmsg":"OK",\n    "data": {"name" : "13313331333"}\n\n}\n#\u6ce8\u518c\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h2",{id:"13\u5177\u4f53\u4e1a\u52a1\u5b9e\u73b0"},"1.3\u5177\u4f53\u4e1a\u52a1\u5b9e\u73b0"),(0,a.kt)("p",null,"session\u7684\u5904\u7406\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u653e\u5728web\u7aef\u6765\u5b9e\u73b0\uff0c\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'//\u5b9a\u4e49\u8fd4\u56de\u6570\u636e\u5bb9\u5668\nresp := make(map[string]interface{})\ndataTmp := make(map[string]string)\n//\u521d\u59cb\u5316session\ns := sessions.Default(ctx)\nuserName := s.Get("userName")\n//\u5bf9\u83b7\u53d6\u7684session\u6821\u9a8c\nif userName == nil{\n    //\u521d\u59cb\u5316\u8fd4\u56de\u503c\n    resp["errno"] = utils.RECODE_SESSIONERR\n    resp["errmsg"] = utils.RecodeText(utils.RECODE_SESSIONERR)\n}else{\n    resp["errno"] = utils.RECODE_OK\n    resp["errmsg"] = utils.RecodeText(utils.RECODE_OK)\n    dataTmp["name"] = userName.(string)\n    resp["data"] = dataTmp\n}\nctx.JSON(200,resp)\n')),(0,a.kt)("h2",{id:"2\u7528\u6237\u4fe1\u606f\u5c55\u793a"},"2.\u7528\u6237\u4fe1\u606f\u5c55\u793a"),(0,a.kt)("h3",{id:"21\u4e1a\u52a1\u6d41\u7a0b\u56fe"},"2.1\u4e1a\u52a1\u6d41\u7a0b\u56fe"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"im",src:r(8437).Z})),(0,a.kt)("h3",{id:"22\u63a5\u53e3\u5b9a\u4e49"},"2.2\u63a5\u53e3\u5b9a\u4e49"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: GET\nurl:api/v1.0/user\n#data:\nno input data\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f",\n  "data": {\n    "user_id": 1,\n    "name": "itcast",\n    "mobile": "110",\n    "real_name": "\u4f20\u667a",\n    "id_card": "210112244556677",\n    "avatar_url": "http://101.200.170.171:8888/group1/M00/00/00/Zciqq1n7It2ANn1dAADexS5wJKs808.png"\n  }\n}\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h2",{id:"23\u670d\u52a1\u7aef\u5b9e\u73b0"},"2.3\u670d\u52a1\u7aef\u5b9e\u73b0"),(0,a.kt)("p",null,"\u9996\u5148\u6211\u4eec\u6839\u636e\u63a5\u53e3\u5b9a\u4e49\u6765\u786e\u5b9aproto\u6587\u4ef6\u7684\u53c2\u6570\uff0c\u4fee\u6539\u540e\u7684proto\u6587\u4ef6\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},'syntax = "proto3";\n\npackage go.micro.srv.getUserInfo;\n\nservice GetUserInfo {\n    rpc Call(Request) returns (Response) {}\n}\n\nmessage Request {\n    string name = 1;\n}\n\nmessage Response {\n    string errno = 1;\n    string errmsg = 2;\n    UserData data = 3;\n}\n\nmessage UserData{\n    int32 user_id = 1;\n    string name = 2;\n    string mobile = 3;\n    string real_name = 4;\n    string id_card = 5;\n    string avatar_url = 6;\n}\n')),(0,a.kt)("p",null,"\u7136\u540e\u4fee\u6539main.go\u6587\u4ef6\uff0c\u518d\u8be6\u7ec6\u7684\u5b9e\u73b0\u6211\u4eec\u7684\u4e1a\u52a1\u65b9\u6cd5\uff0c\u5177\u4f53\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},"    //\u6839\u636e\u7528\u6237\u540d\u83b7\u53d6\u4fe1\u606f\n    db ,err:= model.InitDb()\n    user,err := model.GetUserInfo(db,req.Name)\n\n    if err != nil {\n        rsp.Errno = utils.RECODE_DBERR\n        rsp.Errmsg = utils.RecodeText(utils.RECODE_DBERR)\n        return err\n    }\n\n    var data getUserInfo.UserData\n\n    data.Name = user.Name\n    data.Mobile = user.Mobile\n    data.IdCard = user.Id_card\n    data.RealName = user.Real_name\n    data.AvatarUrl = user.Avatar_url\n    data.UserId  = int32(user.ID)\n\n    rsp.Errno = utils.RECODE_OK\n    rsp.Errmsg = utils.RecodeText(utils.RECODE_OK)\n    rsp.Data  = &data\n\n\n    return nil\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u6ce8\u610f\u51fd\u6570\u7684\u5c01\u88c5\uff0c\u5c01\u88c5\u7684\u51fd\u6570\u5982\u4e0b\uff1a")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'//\u6839\u636e\u7528\u6237\u540d\u83b7\u53d6\u5f53\u524d\u7528\u6237\u4fe1\u606f\nfunc GetUserInfo(db*gorm.DB,name string)(User,error){\n    var user User\n    err := db.Where("name = ?",name).First(&user).Error\n    return user,err\n}\n')),(0,a.kt)("h2",{id:"24web\u7aef\u5b9e\u73b0"},"2.4web\u7aef\u5b9e\u73b0"),(0,a.kt)("p",null,"\u670d\u52a1\u7aef\u5b9e\u73b0\u4e4b\u540e\uff0c\u63a5\u7740\u6211\u4eec\u6765\u5b9e\u73b0web\u7aef\uff0c\u9996\u5148\u6211\u4eec\u8981\u5339\u914d\u76f8\u5e94\u7684\u8def\u7531\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'r1.GET("/user",controller.GetUserInfo)\n')),(0,a.kt)("p",null,"\u7136\u540e\u5b9e\u73b0\u5177\u4f53\u7684\u63a7\u5236\u5668\u51fd\u6570\uff0c\u9996\u5148\u662f\u4ecesession\u4e2d\u83b7\u53d6\u6570\u636e\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'//\u83b7\u53d6\u767b\u5f55\u4fe1\u606f\ns := sessions.Default(ctx)\nuserName := s.Get("userName")\nerrResp := make(map[string]interface{})\nif userName == nil{\n    errResp["errno"] = utils.RECODE_SESSIONERR\n    errResp["errmsg"] = utils.RecodeText(utils.RECODE_SESSIONERR)\n    ctx.JSON(200,errResp)\n    return \n}\n')),(0,a.kt)("p",null,"\u7136\u540e\u8c03\u7528\u8fdc\u7a0b\u670d\u52a1\uff0c\u628a\u7528\u6237\u540d\u4f20\u5230\u8fdc\u7a0b\uff0c\u5e76\u83b7\u53d6\u8fd4\u56de\u503c\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'//\u8fdc\u7a0b\u8c03\u7528\ngrpcService := utils.GetGrpcService()\nclient := getUserInfo.NewGetUserInfoService("go.micro.srv.getUserInfo",grpcServiceClient())\nresp,err := client.Call(context.TODO(),&getUserInfo.Request{Name:userName.(string)})\n\n')),(0,a.kt)("p",null,"\u6839\u636e\u8fd4\u56de\u503c\u786e\u5b9a\u8fd4\u56de\u7ed9\u524d\u7aef\u7684\u6570\u636e\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},"if err != nil {\n    fmt.Println(err)\n    resp.Errno = utils.RECODE_DBERR\n    resp.Errmsg = utils.RecodeText(utils.RECODE_DBERR)\n}\n    \nctx.JSON(200,resp)\n")),(0,a.kt)("h1",{id:"3\u9000\u51fa\u767b\u9646"},"3.\u9000\u51fa\u767b\u9646"),(0,a.kt)("h2",{id:"31\u4e1a\u52a1\u6d41\u7a0b\u56fe"},"3.1\u4e1a\u52a1\u6d41\u7a0b\u56fe"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"mg",src:r(1858).Z})),(0,a.kt)("h2",{id:"32\u63a5\u53e3\u5b9a\u4e49"},"3.2\u63a5\u53e3\u5b9a\u4e49"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: DELETE\nurl:api/v1.0/session\n#data:\nno input data\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n    "errno": "0",\n    "errmsg":"OK",\n}\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h2",{id:"33\u4e1a\u52a1\u5b9e\u73b0"},"3.3\u4e1a\u52a1\u5b9e\u73b0"),(0,a.kt)("p",null,"\u9000\u51fa\u767b\u9646\u5b9e\u73b0\u6bd4\u8f83\u7b80\u5355\uff0c\u76f4\u63a5\u5220\u9664session\u5373\u53ef\uff0c\u9996\u5148\u6211\u4eec\u6765\u5339\u914d\u4e00\u4e0b\u8def\u7531\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'r1.DELETE("/session",controller.DeleteSession)\n')),(0,a.kt)("p",null,"\u7136\u540e\u5728\u63a7\u5236\u5668\u5b9e\u73b0\u5220\u9664session\u8fd4\u56de\u6570\u636e\u64cd\u4f5c\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'func DeleteSession(ctx*gin.Context){\n    resp := make(map[string]interface{})\n\n    //\u5220\u9664session\n    s := sessions.Default(ctx)\n    s.Delete("userName")\n    err := s.Save()\n    if err != nil {\n        resp["errno"] = utils.RECODE_SESSIONERR\n        resp["errmsg"] = utils.RecodeText(utils.RECODE_SESSIONERR)\n    }else {\n        resp["errno"] = utils.RECODE_OK\n        resp["errmsg"] = utils.RecodeText(utils.RECODE_OK)\n    }\n\n    ctx.JSON(200,resp)\n}\n')),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u6ce8\u610f\u3002\u4e0d\u7ba1\u662f\u8bbe\u7f6esession\u8fd8\u662f\u5220\u9664session\u6700\u540e\u90fd\u9700\u8981\u8c03\u7528save\u65b9\u6cd5\u3002")),(0,a.kt)("h2",{id:"4\u767b\u9646\u4e1a\u52a1\u5b9e\u73b0"},"4.\u767b\u9646\u4e1a\u52a1\u5b9e\u73b0"),(0,a.kt)("h3",{id:"41\u4e1a\u52a1\u6d41\u7a0b\u56fe"},"4.1\u4e1a\u52a1\u6d41\u7a0b\u56fe"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"im",src:r(8738).Z})),(0,a.kt)("h3",{id:"42\u63a5\u53e3\u5b9a\u4e49"},"4.2\u63a5\u53e3\u5b9a\u4e49"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: POST\nurl:api/v1.0/sessions\n#data:\n{\n    mobile: "133", //\u624b\u673a\u53f7\n    password: "itcast"//\u5bc6\u7801\n}\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n    "errno": "0",\n    "errmsg":"OK",\n}\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h3",{id:"43\u670d\u52a1\u7aef\u5b9e\u73b0"},"4.3\u670d\u52a1\u7aef\u5b9e\u73b0"),(0,a.kt)("p",null,"\u9996\u5148\u662f\u521b\u5efa\u670d\u52a1\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"$ micro new --type src project/login\n")),(0,a.kt)("p",null,"\u7136\u540e\u6839\u636e\u63a5\u53e3\u5b9a\u4e49\uff0c\u4fee\u6539proto\u53c2\u6570\uff0c\u4fee\u6539\u540e\u7684proto\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},'syntax = "proto3";\n\npackage go.micro.srv.login;\n\nservice Login {\n    rpc Call(Request) returns (Response) {}\n}\n\nmessage Request {\n    string mobile = 1;\n    string password = 2;\n}\n\nmessage Response {\n    string errno = 1;\n    string errmsg = 2;\n    string name = 3;\n}\n')),(0,a.kt)("p",null,"\u7136\u540e\u7f16\u8bd1proto\u6587\u4ef6\uff0c\u751f\u6210\u5bf9\u5e94\u63a5\u53e3\uff0c\u4fee\u6539Main.go\u6587\u4ef6\uff0c\u518d\u5177\u4f53\u5b9e\u73b0\u767b\u9646\u4e1a\u52a1\uff0c\u767b\u9646\u4e1a\u52a1\u5b9e\u73b0\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},"    //\u521d\u59cb\u5316mysql\u8fde\u63a5    \n    db,err := model.InitDb()\n    if err != nil {\n        rsp.Errno = utils.RECODE_DBERR\n        rsp.Errmsg = utils.RecodeText(utils.RECODE_DBERR)\n    }\n    //\u5bf9\u4f20\u5165\u7684\u5bc6\u7801\u8fdb\u884cmd5\u52a0\u5bc6\uff0c\u7136\u540e\u8c03\u7528\u5c01\u88c5\u7684\u51fd\u6570\u8fdb\u884c\u767b\u9646\u6821\u9a8c\uff0c\u6ce8\u610f\u540e\u9762\u9700\u8981\u628a\u7528\u6237\u540d\u5b58\u5165session,\u6240\u4ee5\u8981\u628aname\u4f20\u51fa\n    m5 := md5.New()\n    m5.Write([]byte(req.Password))\n    pwdHash := hex.EncodeToString(m5.Sum(nil))\n    result,name := model.GetLoginInfo(db,req.Mobile,pwdHash)\n    //\u6839\u636e\u7ed3\u679c\u8fd4\u56de\u6570\u636e\n    if result{\n        rsp.Errno = utils.RECODE_OK\n        rsp.Errmsg = utils.RecodeText(utils.RECODE_OK)\n        rsp.Name = name\n    }else {\n        rsp.Errno = utils.RECODE_DATAERR\n        rsp.Errmsg = utils.RecodeText(utils.RECODE_DATAERR)\n    }\n    return nil\n")),(0,a.kt)("p",null,"\u5c01\u88c5\u7684\u51fd\u6570\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'//\u6839\u636e\u7535\u8bdd\u53f7\u548c\u5bc6\u7801\u5224\u65ad,\u767b\u5f55\u662f\u5426\u6210\u529f\nfunc GetLoginInfo(db *gorm.DB,mobile string,pwd string)(bool,string){\n    var user User\n    db.Where("mobile = ?",mobile).First(&user)\n    return user.Password_hash == pwd,user.Name\n}\n')),(0,a.kt)("h3",{id:"44web\u7aef\u5b9e\u73b0"},"4.4web\u7aef\u5b9e\u73b0"),(0,a.kt)("p",null,"\u5904\u7406\u5b8c\u670d\u52a1\u7aef\u63a5\u7740\u6211\u4eec\u6765\u5904\u7406web\u7aef\u5185\u5bb9\uff0c \u9996\u5148\u662f\u505a\u8def\u7531\u5339\u914d\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'r1.POST("/sessions",controller.PostLogin)\n')),(0,a.kt)("p",null,"\u7136\u540e\u5728\u5177\u4f53\u63a7\u5236\u5668\u51fd\u6570\u4e2d\u5b9e\u73b0\u767b\u9646\u4e1a\u52a1\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'//\u767b\u5f55\u5904\u7406\ntype UserLogin struct {\n    Mobile string `json:"mobile"`\n    Password string `json:"password"`\n}\nfunc PostLogin(ctx*gin.Context){\n    //\u5b9a\u4e49\u9519\u8bef\u5bb9\u5668\n    errResp := make(map[string]interface{})\n    //\u83b7\u53d6\u6570\u636e\n    var userLogin UserLogin\n    err := ctx.Bind(&userLogin)\n    if err != nil {\n        errResp["errno"] = utils.RECODE_REQERR\n        errResp["errmsg"] = utils.RecodeText(utils.RECODE_REQERR)\n        ctx.JSON(200,errResp)\n        return\n    }\n\n    //\u8fdc\u7a0b\u670d\u52a1\u8c03\u7528\n    grpcService := utils.GetGrpcService()\n    client := login.NewLoginService("go.micro.srv.login",grpcService.Client())\n    resp,err := client.Call(context.TODO(),&login.Request{Mobile:userLogin.Mobile,Password:userLogin.Password})\n    if err != nil {\n        fmt.Println(err)\n        errResp["errno"] = utils.RECODE_LOGINERR\n        errResp["errmsg"] = utils.RecodeText(utils.RECODE_LOGINERR)\n        ctx.JSON(200,errResp)\n        return\n    }\n    //\u5982\u679c\u8fd4\u56de\u6210\u529f,\u5b58\u50a8session\n    if resp.Errno == utils.RECODE_OK{\n        s := sessions.Default(ctx)\n        s.Set("userName",resp.Name)\n        s.Save()\n    }\n\n    ctx.JSON(200,resp)\n}\n')),(0,a.kt)("h2",{id:"5\u4e0a\u4f20\u7528\u6237\u5934\u50cf\u4e1a\u52a1"},"5.\u4e0a\u4f20\u7528\u6237\u5934\u50cf\u4e1a\u52a1"),(0,a.kt)("h3",{id:"51\u4e1a\u52a1\u6d41\u7a0b\u56fe"},"5.1\u4e1a\u52a1\u6d41\u7a0b\u56fe"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"im",src:r(3213).Z})),(0,a.kt)("h3",{id:"52\u63a5\u53e3\u5b9a\u4e49"},"5.2\u63a5\u53e3\u5b9a\u4e49"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'#Request:\nmethod: POST\nurl:api/v1.0/user/avatar\n#data:\n\u56fe\u7247\u7684\u4e8c\u8fdb\u5236\u6570\u636e\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f",\n  "data": {\n    "avatar_url": "http://101.200.170.171:8888/group1/M00/00/00/Zciqq1n6_L-AOB04AADexS5wJKs662.png" //\u56fe\u7247\u5730\u5740\u9700\u8981\u8fdb\u884c\u62fc\u63a5\n  } \n\n}\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h3",{id:"53\u670d\u52a1\u7aef\u5b9e\u73b0"},"5.3\u670d\u52a1\u7aef\u5b9e\u73b0"),(0,a.kt)("p",null,"\u9996\u5148\u521b\u5efa\u670d\u52a1\u3002\u547d\u4ee4\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"$ micro new --type srv project/postAva\n")),(0,a.kt)("p",null,"\u7136\u540e\u6839\u636e\u63a5\u53e3\u5b9a\u4e49\u786e\u5b9aproto\u6587\u4ef6\u5185\u5bb9\uff0cproto\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},'syntax = "proto3";\n\npackage go.micro.srv.postAvatar;\n\nservice PostAvatar {\n    rpc Call(Request) returns (Response) {}\n}\n\n\nmessage Request {\n    string name = 1;\n    bytes file = 2;\n    string fileExt = 3;\n}\n\nmessage Response {\n    string errno = 1;\n    string errmsg = 2;\n    ImgPath data = 3;\n}\n\nmessage ImgPath{\n    string avatar_url = 1;\n}\n\n')),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"\u8fd9\u91cc\u6ce8\u610f\uff0c\u6211\u4eec\u628a\u6587\u4ef6\u5b58\u50a8\u7684\u65f6\u5019\u9700\u8981\u83b7\u53d6\u6587\u4ef6\u683c\u5f0f\u4fe1\u606f\uff0c\u6240\u7cfb\u9700\u8981\u628a\u6587\u4ef6\u683c\u5f0f\u4f20\u9012\u8fc7\u6765\uff0c\u5934\u50cf\u4fe1\u606f\u4e0a\u4f20\u4e4b\u540e\u9700\u8981\u548c\u5f53\u524d\u7528\u6237\u7ed1\u5b9a\uff0c\u6240\u4ee5\u9700\u8981\u628a\u7528\u6237\u540d\u4f20\u9012\u8fc7\u6765\u3002")),(0,a.kt)("p",null,"\u7136\u540e\u7f16\u8bd1proto\u5e76\u4fee\u6539main.go\u6587\u4ef6\uff0c\u518d\u53bbhandler\u4e2d\u5b9e\u73b0\u5177\u4f53\u4e1a\u52a1\uff0c\u4e1a\u52a1\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'    //\u89e3\u6790\u51fa\u6765\u6587\u4ef6\n    client ,_:= fdfs_client.NewFdfsClient("/etc/fdfs/client.conf")\n\n    uploadResp ,err := client.UploadByBuffer(req.File,req.FileExt)\n    if err != nil {\n        rsp.Errno = utils.RECODE_IOERR\n        rsp.Errmsg = utils.RecodeText(utils.RECODE_IOERR)\n        return err\n    }\n    //\u7ed9\u8fd4\u56de\u503c\u8d4b\u503c\n    rsp.Errno = utils.RECODE_OK\n    rsp.Errmsg = utils.RecodeText(utils.RECODE_OK)\n    var imgPath postAvatar.ImgPath\n    imgPath.AvatarUrl = "http://192.168.137.130:8888/"+uploadResp.RemoteFileId\n\n    rsp.Data = &imgPath\n    return nil\n')),(0,a.kt)("h3",{id:"54web\u7aef\u5b9e\u73b0"},"5.4web\u7aef\u5b9e\u73b0"),(0,a.kt)("p",null,"\u5177\u4f53\u5b9e\u73b0\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'func PostAvatar(ctx*gin.Context){\n\n    //\u5b9a\u4e49\u9519\u8bef\u8fd4\u56de\u5bb9\u5668\n    errResp := make(map[string]interface{})\n\n    //\u83b7\u53d6\u524d\u6bb5\u4f20\u9012\u7684\u6587\u4ef6\n    fileHeader ,err:= ctx.FormFile("avatar")\n    if err != nil {\n        errResp["errno"] = utils.RECODE_REQERR\n        errResp["errmsg"] = utils.RecodeText(utils.RECODE_REQERR)\n        ctx.JSON(200,errResp)\n        return\n    }\n\n    //\u5224\u65ad\u6587\u4ef6\u5927\u5c0f\u53ca\u683c\u5f0f\u662f\u5426\u6b63\u786e\n    if fileHeader.Size > 500000{\n        errResp["errno"] = utils.RECODE_DATAERR\n        errResp["errmsg"] = utils.RecodeText(utils.RECODE_DATAERR)\n        ctx.JSON(200,errResp)\n        return\n    }\n    fileExt:= path.Ext(fileHeader.Filename)\n    if fileExt != ".jpg" && fileExt != ".png" && fileExt != ".jpeg"{\n        errResp["errno"] = utils.RECODE_DATAERR\n        errResp["errmsg"] = utils.RecodeText(utils.RECODE_DATAERR)\n        ctx.JSON(200,errResp)\n        return\n    }\n\n    //\u83b7\u53d6\u6587\u4ef6\u6d41,\u5e76\u5199\u6210\u5b57\u8282\u683c\u5f0f\n    file ,_ :=fileHeader.Open()\n    buffer := make([]byte,fileHeader.Size)\n    file.Read(buffer)\n\n    //\u83b7\u53d6\u7528\u6237\u540d\n    s := sessions.Default(ctx)\n    userName := s.Get("userName")\n\n    //\u8c03\u7528\u8fdc\u7a0b\u670d\u52a1\n    grpcService := utils.GetGrpcService()\n    client := postAva.NewPostAvatarService("go.micro.srv.postAvatar",grpcService.Client())\n    resp ,err:= client.Call(context.TODO(),&postAva.Request{\n        FileExt:fileExt,\n        File:buffer,\n        Name:userName.(string),\n    })\n\n    if err != nil{\n        errResp["errno"] = utils.RECODE_IOERR\n        errResp["errmsg"] = utils.RecodeText(utils.RECODE_IOERR)\n        ctx.JSON(200,errResp)\n        return\n    }\n\n    ctx.JSON(200,resp)\n}\n')),(0,a.kt)("h2",{id:"6\u66f4\u65b0\u7528\u6237\u540d"},"6.\u66f4\u65b0\u7528\u6237\u540d"),(0,a.kt)("h3",{id:"61\u4e1a\u52a1\u6d41\u7a0b\u56fe"},"6.1\u4e1a\u52a1\u6d41\u7a0b\u56fe"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"im",src:r(2061).Z})),(0,a.kt)("h3",{id:"62\u63a5\u53e3\u5b9a\u4e49"},"6.2\u63a5\u53e3\u5b9a\u4e49"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: PUT\nurl:api/v1.0/user/name\n#data:\n{\n "name":"panda"\n}\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f",\n  "data": {\n    "name": "Panda"\n  }\n}\n\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h3",{id:"63\u670d\u52a1\u7aef\u5b9e\u73b0"},"6.3\u670d\u52a1\u7aef\u5b9e\u73b0"),(0,a.kt)("h3",{id:"64web\u7aef\u5b9e\u73b0"},"6.4web\u7aef\u5b9e\u73b0"),(0,a.kt)("h2",{id:"7\u68c0\u67e5\u7528\u6237\u5b9e\u540d\u8ba4\u8bc1"},"7.\u68c0\u67e5\u7528\u6237\u5b9e\u540d\u8ba4\u8bc1"),(0,a.kt)("h3",{id:"71\u4e1a\u52a1\u6d41\u7a0b\u56fe"},"7.1\u4e1a\u52a1\u6d41\u7a0b\u56fe"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"im",src:r(8022).Z})),(0,a.kt)("h3",{id:"72\u63a5\u53e3\u5b9a\u4e49"},"7.2\u63a5\u53e3\u5b9a\u4e49"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'#Request:\nmethod: GET\nurl:api/v1.0/user/auth\n#data:\nno input data\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f",\n  "data": {\n    "user_id": 1,\n    "name": "Panda",\n    "password": "123123",\n    "mobile": "110",\n    "real_name": "\u718a\u732b",\n    "id_card": "210112244556677",\n    "avatar_url": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1n7It2ANn1dAADexS5wJKs808.png"\n  }\n}\n\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h3",{id:"73\u670d\u52a1\u7aef\u5b9e\u73b0"},"7.3\u670d\u52a1\u7aef\u5b9e\u73b0"),(0,a.kt)("h3",{id:"74web\u7aef\u5b9e\u73b0"},"7.4web\u7aef\u5b9e\u73b0"),(0,a.kt)("h2",{id:"8\u66f4\u65b0\u7528\u6237\u5b9e\u540d\u8ba4\u8bc1"},"8.\u66f4\u65b0\u7528\u6237\u5b9e\u540d\u8ba4\u8bc1"),(0,a.kt)("h3",{id:"81\u4e1a\u52a1\u6d41\u7a0b\u56fe"},"8.1\u4e1a\u52a1\u6d41\u7a0b\u56fe"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"im",src:r(9124).Z})),(0,a.kt)("h3",{id:"82\u63a5\u53e3\u5b9a\u4e49"},"8.2\u63a5\u53e3\u5b9a\u4e49"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: POST\nurl:api/v1.0/user/auth\n#data:\n{\n    real_name: "\u718a\u732b", \n    id_card: "21011223344556677"\n}\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f"\n}\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h3",{id:"83\u670d\u52a1\u7aef\u5b9e\u73b0"},"8.3\u670d\u52a1\u7aef\u5b9e\u73b0"),(0,a.kt)("h3",{id:"84web\u7aef\u5b9e\u73b0"},"8.4web\u7aef\u5b9e\u73b0"),(0,a.kt)("h2",{id:"9-\u83b7\u53d6\u5f53\u524d\u7528\u6237\u5df2\u53d1\u5e03\u623f\u6e90\u4fe1\u606f"},"9 \u83b7\u53d6\u5f53\u524d\u7528\u6237\u5df2\u53d1\u5e03\u623f\u6e90\u4fe1\u606f"),(0,a.kt)("p",null,"\u83b7\u53d6\u7528\u6237\u5df2\u53d1\u5e03\u623f\u6e90\u4fe1\u606f\u670d\u52a1\uff08\u5546\u54c1\u76f8\u5173\uff09"),(0,a.kt)("h3",{id:"\u521b\u5efa\u547d\u4ee4"},"\u521b\u5efa\u547d\u4ee4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'$ micro new --type "srv" sss/GetUserHouses\n')),(0,a.kt)("h3",{id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3"},"\u6d41\u7a0b\u4e0e\u63a5\u53e3"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"mg",src:r(3849).Z})),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: GET\nurl:api/v1.0/user/houses\n#data:\nno input data\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f",\n  "data": {\n    "houses": [\n      {\n        "address": "\u897f\u4e09\u65d7\u6865\u4e1c",\n        "area_name": "\u660c\u5e73\u533a",\n        "ctime": "2017-11-06 11:16:24",\n        "house_id": 1,\n        "img_url": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJY-AL3m8AAS8K2x8TDE052.jpg",\n        "order_count": 0,\n        "price": 100,\n        "room_count": 2,\n        "title": "\u4e0a\u5965\u4e16\u7eaa\u4e2d\u5fc3",\n        "user_avatar": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png"\n      },\n      {\n        "address": "\u5317\u6e05\u8def\u90d1\u4e0a\u8def",\n        "area_name": "\u987a\u4e49\u533a",\n        "ctime": "2017-11-06 11:38:54",\n        "house_id": 2,\n        "img_url": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBKtmAC8y8AAZcKg5PznU817.jpg",\n        "order_count": 0,\n        "price": 1000,\n        "room_count": 1,\n        "title": "\u4fee\u6b63\u5927\u53a6302\u6559\u5ba4",\n        "user_avatar": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png"\n      }\n    ]\n  }\n}\n\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h3",{id:"\u670d\u52a1\u7aef\u5b9e\u73b0"},"\u670d\u52a1\u7aef\u5b9e\u73b0"),(0,a.kt)("p",null,"\u6839\u636e\u63a5\u53e3\u5b9a\u4e49\uff0c\u751f\u6210\u5bf9\u5e94\u7684proto\u6587\u4ef6\uff0cproto\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},'syntax = "proto3";\n\npackage go.micro.srv.getHouse;\n\nservice GetHouse {\n    rpc Call(Request) returns (Response) {}\n}\n\n\nmessage Request {\n    string name = 1;\n}\n\nmessage Response {\n    string errno = 1;\n    string errmsg = 2;\n    houses data = 3;\n}\n\nmessage houses{\n    repeated houseInfo houses = 1;\n}\n\nmessage houseInfo {\n    string address = 1;\n    string area_name = 2;\n    string ctime = 3;\n    int32 house_id = 4;\n    string img_url = 5;\n    int32 order_count = 6;\n    int32 price = 7;\n    int32 room_count = 8;\n    string title = 9;\n    string user_avatar = 10;\n}\n')),(0,a.kt)("p",null,"\u7136\u540e\u7f16\u8bd1proto\u6587\u4ef6\uff0c\u63a5\u7740\u53bbmain.go\u6587\u4ef6\u4e2d\uff0c\u5220\u9664\u4e0d\u9700\u8981\u7684\u90e8\u5206\uff0c\u5e76\u6dfb\u52a0consul\u670d\u52a1\u53d1\u73b0\uff0c\u7136\u540e\u53bbhander\u91cc\u9762\u5904\u7406\u5177\u4f53\u7684\u4e1a\u52a1\u4ee3\u7801\uff0c\u5177\u4f53\u4ee3\u7801\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'func (e *GetHouse) Call(ctx context.Context, req *getHouse.Request, rsp *getHouse.Response) error {\n    //\u67e5\u8be2\u6570\u636e\u5e93,\u6839\u636e\u7528\u6237\u540d\u83b7\u53d6\u623f\u6e90\u4fe1\u606f\n    db,err :=model.InitDb()\n    if err != nil{\n        return err\n    }\n    //\u5177\u4f53\u6570\u636e\u5e93\u64cd\u4f5c\uff0c\u5c01\u88c5\u6210\u51fd\u6570\uff0c\u5728\u4e0b\u9762\u5c55\u793a\n    houses,user,areas,err :=model.GetHouses(db,req.Name)\n\n\n    if err != nil {\n        fmt.Println(err)\n        return err\n    }\n\n    //\u6839\u636e\u8fd4\u56de\u6570\u636e\uff0c\u6784\u9020\u8fd4\u56de\u503c\n    var houseInfos getHouse.Houses\n    for k,v := range houses{\n        var house getHouse.HouseInfo\n\n        house.Address = v.Address\n        house.HouseId = int32(v.ID)\n        house.Ctime = v.CreatedAt.Format("2006-01-02 15:04:05")\n        house.ImgUrl = v.Index_image_url\n        house.OrderCount = int32(v.Order_count)\n        house.Price = int32(v.Price)\n        house.RoomCount = int32(v.Room_count)\n        house.Title = v.Title\n        house.UserAvatar = user.Avatar_url\n        house.AreaName = areas[k].Name\n\n        houseInfos.Houses = append(houseInfos.Houses,&house)\n    }\n\n    fmt.Println("houseInfos = ",houseInfos,"areas = ",areas)\n    \n    //\u8fd4\u56de\u6570\u636e\n    rsp.Errno = utils.RECODE_OK\n    rsp.Errmsg = utils.RecodeText(utils.RECODE_OK)\n    rsp.Data = &houseInfos\n\n\n    return nil\n}\n')),(0,a.kt)("p",null,"\u8fd9\u91cc\u6211\u4eec\u628a\u6570\u636e\u5e93\u64cd\u4f5c\u5c01\u88c5\u5230\u51fd\u6570\u91cc\u9762\uff0c\u51fd\u6570\u5b9e\u73b0\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'//\u6839\u636e\u7528\u6237\u540d\u83b7\u53d6\u5f53\u524d\u7528\u6237\u7684\u623f\u6e90\u4fe1\u606f\nfunc GetHouses(db *gorm.DB, name string) ([]House, User, []Area, error) {\n    //\u67e5\u8be2\u5f53\u524d\u7528\u6237\u5bf9\u8c61\n    var user User\n    err := db.Where("name = ?", name).First(&user).Error\n    if err != nil {\n        return nil, User{}, nil, err\n    }\n\n    //\u67e5\u8be2\u5f53\u524d\u7528\u6237\u5bf9\u5e94\u7684\u623f\u5c4b\n    var houses []House\n    err = db.Model(&user).Related(&houses).Error\n    if err != nil {\n        return nil, User{}, nil, err\n    }\n\n    //\u83b7\u53d6\u5404\u4e2a\u623f\u6e90\u5bf9\u5e94\u7684\u5730\u5740\n    var areas []Area\n    for _, v := range houses {\n        var area Area\n        err = db.Model(&v).Related(&area).Error\n\n        if err != nil {\n            return nil, User{}, nil, err\n        }\n\n        areas = append(areas, area)\n    }\n    return houses, user, areas, nil\n}\n')),(0,a.kt)("h3",{id:"web\u7aef\u5b9e\u73b0"},"web\u7aef\u5b9e\u73b0"),(0,a.kt)("p",null,"\u6839\u636e\u8bbe\u8ba1\u6587\u6863\uff0c\u8fd9\u91cc\u6211\u4eec\u7ed9\u5bf9\u5e94\u8bf7\u6c42\u6dfb\u52a0\u8def\u7531\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'r1.GET("/user/houses",controller.GetUserHouses)\n')),(0,a.kt)("p",null,"\u7136\u540e\u5230controller\u4e2d\u5b9e\u73b0\u5bf9\u5e94\u8bf7\u6c42\u65b9\u6cd5\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'//\u83b7\u53d6\u5f53\u524d\u7528\u6237\u53d1\u5e03\u623f\u6e90\u4fe1\u606f\nfunc GetUserHouses(ctx*gin.Context){\n\n    //\u83b7\u53d6\u7528\u6237\u540d\n    s := sessions.Default(ctx)\n    userName := s.Get("userName")\n\n    //\u8c03\u7528\u8fdc\u7a0b\u670d\u52a1\n    grpcService := utils.GetGrpcService()\n    client := getHouse.NewGetHouseService(utils.GetHouseName,grpcService.Client())\n    resp,err := client.Call(context.TODO(),&getHouse.Request{Name:userName.(string)})\n    fmt.Println("resp = ",err)\n\n    if err != nil {\n        resp.Errno = utils.RECODE_SERVERERR\n        resp.Errmsg = utils.RecodeText(utils.RECODE_SERVERERR)\n    }\n\n    ctx.JSON(200,resp)\n}\n')),(0,a.kt)("h2",{id:"10-\u53d1\u5e03\u623f\u6e90\u4fe1\u606f"},"10 \u53d1\u5e03\u623f\u6e90\u4fe1\u606f"),(0,a.kt)("p",null,"\u53d1\u9001\uff08\u53d1\u5e03\uff09\u623f\u6e90\u4fe1\u606f\u670d\u52a1\uff08\u5546\u54c1\u76f8\u5173\uff09"),(0,a.kt)("h3",{id:"\u521b\u5efa\u547d\u4ee4-1"},"\u521b\u5efa\u547d\u4ee4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'$ micro new --type "srv" sss/PostHouses\n')),(0,a.kt)("h3",{id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-1"},"\u6d41\u7a0b\u4e0e\u63a5\u53e3"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"mg",src:r(901).Z})),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: POST\nurl:api/v1.0/houses\n#data:\n{\n"title":"\u4e0a\u5965\u4e16\u7eaa\u4e2d\u5fc3",\n"price":"666",\n"area_id":"5",\n"address":"\u897f\u4e09\u65d7\u6865\u4e1c\u5efa\u6750\u57ce1\u53f7",\n"room_count":"2",\n"acreage":"60",\n"unit":"2\u5ba41\u5385",\n"capacity":"3",\n"beds":"\u53cc\u4eba\u5e8a2\u5f20",\n"deposit":"200",\n"min_days":"3",\n"max_days":"0",\n"facility":["1","2","3","7","12","14","16","17","18","21","22"]\n}\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f"\n  "data" :{\n        "house_id": "1"\n  }\n}\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h3",{id:"\u670d\u52a1\u7aef\u5b9e\u73b0-1"},"\u670d\u52a1\u7aef\u5b9e\u73b0"),(0,a.kt)("p",null,"\u521b\u5efa\u670d\u52a1\uff0c\u7136\u540e\u6839\u636e\u63a5\u53e3\u5b9a\u4e49\u6211\u4eec\u6765\u4fee\u6539\u670d\u52a1\u7684proto\u6587\u4ef6\uff0cproto\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'syntax = "proto3";\n\npackage go.micro.srv.postHouse;\n\nservice PostHouse {\n    rpc Call(Request) returns (Response) {}\n}\n\n\nmessage Request {\n    string acreage = 1;\n    string address = 2;\n    string area_id = 3;\n    string beds = 4;\n    string capacity = 5;\n    string deposit = 6;\n    repeated string facility = 7;\n    string min_days = 8;\n    string max_days = 9;\n    string price = 10;\n    string room_count = 11;\n    string title = 12;\n    string unit = 13;\n\n    string name = 14;\n}\n\nmessage Response {\n    string errno = 1;\n    string errmsg = 2;\n    map<string,int32> data = 3;\n}\n')),(0,a.kt)("p",null,"\u4fee\u6539main.go\u6587\u4ef6\uff0c\u7136\u540e\u5230handler\u4e2d\u5b9e\u73b0\u5177\u4f53\u670d\u52a1\u5185\u5bb9\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'    //\u53d1\u5e03\u623f\u6e90,\u63d2\u5165\u64cd\u4f5c\n    db,err := model.InitDb()\n    //\u5411\u6570\u636e\u5e93\u4e2d\u63d2\u5165\u6570\u636e\n    var house model.House\n    acrea,_ :=strconv.Atoi(req.Acreage)\n    house.Acreage = acrea\n    house.Address = req.Address\n    areaId ,_ :=strconv.Atoi(req.AreaId)\n    house.AreaId = uint(areaId)\n    house.Beds = req.Beds\n    cap,_ :=strconv.Atoi(req.Capacity)\n    house.Capacity = cap\n    dep ,_ :=strconv.Atoi(req.Deposit)\n    house.Deposit = dep\n    maxDays ,_ :=strconv.Atoi(req.MaxDays)\n    house.Max_days = maxDays\n    minDays,_ :=strconv.Atoi(req.MinDays)\n    house.Min_days = minDays\n    price ,_:= strconv.Atoi(req.Price)\n    house.Price = price\n    house.Title = req.Title\n    house.Unit = req.Unit\n\n    roomCount,_ :=strconv.Atoi(req.RoomCount)\n    house.Room_count = roomCount\n    //\u5728model\u4e2d\u5c01\u88c5\u63d2\u5165\u51fd\u6570\uff0c\u5177\u4f53\u5b9e\u73b0\u8bf7\u5f80\u4e0b\u770b\n    houseId,err := model.InserHouse(db,req.Name,house,req.Facility)\n    if err != nil{\n        return err\n    }\n\n    //\u8bbe\u7f6e\u8fd4\u56de\u503c\n    rsp.Errno = utils.RECODE_OK\n    rsp.Errmsg = utils.RecodeText(utils.RECODE_OK)\n    rsp.Data = map[string]int32{"house_id":int32(houseId)}\n\n\n    return nil\n')),(0,a.kt)("p",null,"model\u4e2d\u63d2\u5165\u623f\u6e90\u51fd\u6570\u5b9e\u73b0\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'//\u53d1\u5e03\u623f\u6e90\nfunc InserHouse(db*gorm.DB,name string,house House,fids []string)(uint,error){\n    //\u6839\u636e\u7528\u6237\u540d\u83b7\u53d6\u7528\u6237Id\n    var user User\n    user.Name = name\n    err := db.Where("name = ?",name).Find(&user).Error\n    if err != nil {\n        return 0, err\n    }\n    //\u5173\u8054\u5f53\u524d\u7528\u6237\n    house.UserId = uint(user.ID)\n    //\u67e5\u8be2\u6240\u6709\u5bb6\u5177\u653e\u5230house\u91cc\u9762\n    for _,v := range fids{\n        id ,_:=strconv.Atoi(v)\n\n        var fac Facility\n        err := db.Where("id = ?",id).Find(&fac).Error\n        if err != nil{\n            return 0,err\n        }\n\n        house.Facilities = append(house.Facilities,&fac)\n    }\n    return house.ID, db.Create(&house).Error\n}\n')),(0,a.kt)("h3",{id:"web\u7aef\u5b9e\u73b0-1"},"web\u7aef\u5b9e\u73b0"),(0,a.kt)("p",null,"\u6839\u636e\u63a5\u53e3\u6587\u6863\u5b9a\u4e49\uff0c\u7ed9\u5bf9\u5e94\u8bf7\u6c42\u6dfb\u52a0\u8def\u7531\u5bf9\u5e94\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'r1.POST("/houses",controller.PostHouses)\n')),(0,a.kt)("p",null,"\u7136\u540e\u5230controller\u4e2d\u5b9e\u73b0\u5177\u4f53\u64cd\u4f5c\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'type HouseInfo struct {\n    Title string `json:"title"`\n    Acreage string `json:"acreage"`\n    Address string  `json:"address"`\n    AreaId string  `json:"area_id"`\n    Beds string    `json:"beds"`\n    Capacity string `json:"capacity"`\n    Deposit string `json:"deposit"`\n    Facility []string `json:"facility"`\n    MaxDays string `json:"max_days"`\n    MinDays string `json:"min_days"`\n    Price string   `json:"price"`\n    RoomCount string `json:"room_count"`\n    Unit string    `json:"unit"`\n}\n\n//\u53d1\u5e03\u623f\u6e90\nfunc PostHouses(ctx*gin.Context){\n    //\u5b9a\u4e49\u9519\u8bef\u5bb9\u5668\n    errResp := make(map[string]interface{})\n\n    //\u83b7\u53d6\u524d\u7aef\u4f20\u9012\u8fc7\u6765\u7684\u6570\u636e\n    var houseInfo HouseInfo\n    err := ctx.Bind(&houseInfo)\n    if err != nil {\n        errResp["errno"] = utils.RECODE_REQERR\n        errResp["errmsg"] = utils.RecodeText(utils.RECODE_REQERR)\n        ctx.JSON(200,errResp)\n        return\n    }\n\n    fmt.Println("houseInfo = ",houseInfo)\n    //\u83b7\u53d6\u5f53\u524d\u7528\u6237\u540d\n    s := sessions.Default(ctx)\n    userName := s.Get("userName")\n\n    //\u8fdc\u7a0b\u670d\u52a1\u8c03\u7528\n    grpcService := utils.GetGrpcService()\n    client := postHouse.NewPostHouseService(utils.PostHouseName,grpcService.Client())\n    resp ,err:=client.Call(context.TODO(),&postHouse.Request{\n        Name:userName.(string),\n        Acreage:houseInfo.Acreage,\n        Address:houseInfo.Address,\n        AreaId:houseInfo.AreaId,\n        Beds:houseInfo.Beds,\n        Capacity:houseInfo.Capacity,\n        Deposit:houseInfo.Deposit,\n        Facility:houseInfo.Facility,\n        MaxDays:houseInfo.MaxDays,\n        MinDays:houseInfo.MinDays,\n        Price:houseInfo.Price,\n        RoomCount:houseInfo.RoomCount,\n        Title:houseInfo.Title,\n        Unit:houseInfo.Unit,\n    })\n\n    //\u8fd4\u56de\u6570\u636e\n    if err != nil {\n        fmt.Println(err)\n        errResp["errno"] = utils.RECODE_SERVERERR\n        errResp["errmsg"] = utils.RecodeText(utils.RECODE_SERVERERR)\n        ctx.JSON(200,errResp)\n        return\n    }\n\n    ctx.JSON(200,resp)\n}\n')),(0,a.kt)("h2",{id:"11-\u4e0a\u4f20\u623f\u5c4b\u56fe\u7247"},"11 \u4e0a\u4f20\u623f\u5c4b\u56fe\u7247"),(0,a.kt)("p",null,"\u53d1\u9001\uff08\u4e0a\u4f20\uff09\u623f\u5c4b\u56fe\u7247\u670d\u52a1\uff08\u5546\u54c1\u76f8\u5173\uff09"),(0,a.kt)("h3",{id:"\u521b\u5efa\u547d\u4ee4-2"},"\u521b\u5efa\u547d\u4ee4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'$ micro new --type "srv" sss/PostHousesImage\n')),(0,a.kt)("h3",{id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-2"},"\u6d41\u7a0b\u4e0e\u63a5\u53e3"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"im",src:r(2625).Z})),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: POST\n#3\u8868\u793a\u623f\u6e90id\nurl:api/v1.0/houses/3/images \nurl:api/v1.0/houses/:id/images \n\n#data:\n\u56fe\u7247\u4e8c\u8fdb\u5236\u6570\u636e\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f",\n  "data": {\n    "url": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLmWAHlsrAAaInSze-cQ719.jpg"\n  }\n}\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h3",{id:"\u670d\u52a1\u7aef\u5b9e\u73b0-2"},"\u670d\u52a1\u7aef\u5b9e\u73b0"),(0,a.kt)("p",null,"\u521b\u5efa\u670d\u52a1\uff0c\u6839\u636e\u63a5\u53e3\u5b9a\u4e49\uff0c\u4fee\u6539proto\u6587\u4ef6\uff0cproto\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'syntax = "proto3";\n\npackage go.micro.srv.uploadHouseImage;\n\nservice UploadHouseImage {\n    rpc Call(Request) returns (Response) {}\n}\n\nmessage Request {\n    int32 house_id = 1;\n    bytes houseBuffer = 2;\n    string fileExt = 3;\n}\n\nmessage Response {\n    string errno = 1;\n    string errmsg = 2;\n    map<string,string>data = 3;\n}\n')),(0,a.kt)("p",null,"\u4fee\u6539main.go\u6587\u4ef6\uff0c\u6dfb\u52a0consul\u670d\u52a1\u53d1\u73b0\uff0c\u7136\u540e\u5b9e\u73b0hander\u4e2d\u5177\u4f53\u7684\u4e1a\u52a1\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'    //\u83b7\u53d6fastDFS\u64cd\u4f5c\u5bf9\u8c61\n    fdfsClient,err:= fdfs_client.NewFdfsClient("/etc/fdfs/client.conf")\n    if err != nil{\n        return err\n    }\n    //\u901a\u8fc7\u5b57\u8282\u5207\u7247\u4e0a\u4f20\u6587\u4ef6\u5230fastDFS\n    fdfsResp,err := fdfsClient.UploadByBuffer(req.HouseBuffer,req.FileExt)\n    if err != nil {\n        return err\n    }\n\n    //\u628a\u6570\u636e\u5b58\u50a8\u5230\u6570\u636e\u5e93,\u8fd9\u91cc\u628a\u6570\u636e\u5e93\u64cd\u4f5c\u5c01\u88c5\u6210\u51fd\u6570\uff0c\u5177\u4f53\u4ee3\u7801\u5f80\u4e0b\u770b\n    db,err := model.InitDb()\n    err = model.UploadHouseImage(db,uint(req.HouseId),utils.NginxPath+fdfsResp.RemoteFileId)\n    if err != nil {\n        return err\n    }\n\n    //\u8fd4\u56de\u6570\u636e\n    rsp.Errno = utils.RECODE_OK\n    rsp.Errmsg = utils.RecodeText(utils.RECODE_OK)\n    rsp.Data = map[string]string{"url":utils.NginxPath+fdfsResp.RemoteFileId}\n\n    return nil\n')),(0,a.kt)("p",null,"models\u4e2d\u4e0a\u4f20\u623f\u5c4b\u56fe\u7247\u7684\u64cd\u4f5c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'//\u4e0a\u4f20\u623f\u5c4b\u56fe\u7247\nfunc UploadHouseImage(db*gorm.DB,houseId uint,imgUrl string)error{\n    var house House\n\n    //\u67e5\u8be2\u5bf9\u5e94 \u623f\u5c4b\u4fe1\u606f\n    err := db.First(&house,houseId).Error\n    if err != nil {\n        return err\n    }\n\n    if house.Index_image_url == ""{\n        err = db.Model(&house).Update("index_image_url",imgUrl).Error\n        if err != nil {\n            return err\n        }\n    }else {\n        var houseImage HouseImage\n        houseImage.HouseId = houseId\n        return db.Create(&houseImage).Error\n    }\n    return nil\n}\n')),(0,a.kt)("h3",{id:"web\u7aef\u5b9e\u73b0-2"},"web\u7aef\u5b9e\u73b0"),(0,a.kt)("p",null,"\u6839\u636e\u63a5\u53e3\u6587\u6863\uff0c\u7ed9\u8bf7\u6c42\u6dfb\u52a0\u5bf9\u5e94\u8def\u7531\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'r1.POST("/houses/:id/images",controller.PostHousesImage)\n')),(0,a.kt)("p",null,"\u63a5\u7740\u5230controller\u4e2d\u5b9e\u73b0\u5177\u4f53\u4ee3\u7801\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'func PostHousesImage(ctx*gin.Context){\n    errResp := make(map[string]string)\n    //\u83b7\u53d6\u6570\u636e\n    houseId := ctx.Param("id")\n    //\u8fd9\u91cc\u6211\u4eec\u53d1\u73b0\uff0c\u5df2\u7ecf\u64cd\u4f5c\u4e0a\u4f20\u6587\u4ef6\u4e24\u6b21\u4e86\uff0c\u53ef\u4ee5\u628a\u4e0a\u4f20\u6587\u4ef6\u64cd\u4f5c\u5c01\u88c5\u6210\u51fd\u6570\uff0c\u4ee3\u7801\u5728\u4e0b\u9762\n    fileBuffer,fileExt := UploadFile(ctx,errResp,"house_image")\n    if fileBuffer == nil {\n        ctx.JSON(200,errResp)\n        return\n    }\n\n    //\u8c03\u7528\u8fdc\u7a0b\u670d\u52a1\n    id,_ := strconv.Atoi(houseId)\n    grpcService := utils.GetGrpcService()\n    client := uploadHouseImage.NewUploadHouseImageService(utils.UploadHouseImage,grpcService.Client())\n    resp,err := client.Call(context.TODO(),&uploadHouseImage.Request{\n        HouseId:int32(id),\n        FileExt:fileExt,\n        HouseBuffer:fileBuffer,\n        })\n    //\u8fd4\u56de\u6570\u636e\n    if err != nil {\n        fmt.Println(err)\n        errResp["errno"] = utils.RECODE_SERVERERR\n        errResp["errmsg"] = utils.RecodeText(utils.RECODE_SERVERERR)\n        ctx.JSON(200,errResp)\n        return\n    }\n\n    ctx.JSON(200,resp)\n}\n')),(0,a.kt)("p",null,"\u4e0a\u4f20\u6587\u4ef6\u7684\u51fd\u6570\u5c01\u88c5\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'func UploadFile(ctx*gin.Context,errResp map[string]string,fileName string)([]byte,string){\n    //\u83b7\u53d6\u6570\u636e\n    fileHeader,err := ctx.FormFile(fileName)\n    //\u6821\u9a8c\u6570\u636e\n    if err != nil {\n        errResp["errno"] = utils.RECODE_DATAERR\n        errResp["errmsg"] = utils.RecodeText(utils.RECODE_DATAERR)\n        return nil,""\n    }\n    //\u5927\u5c0f\u6821\u9a8c\n    if fileHeader.Size > 500000{\n        errResp["errno"] = utils.RECODE_MOREBIG\n        errResp["errmsg"] = utils.RecodeText(utils.RECODE_MOREBIG)\n        return nil,""\n    }\n\n    //\u683c\u5f0f\u6821\u9a8c\n    fileExt := path.Ext(fileHeader.Filename)\n    if fileExt != ".jpg" && fileExt != ".png" && fileExt != ".jepg"{\n        errResp["errno"] = utils.RECODE_FORMATERR\n        errResp["errmsg"] = utils.RecodeText(utils.RECODE_FORMATERR)\n        return nil,""\n    }\n\n    file,_ := fileHeader.Open()\n    buffer := make([]byte,fileHeader.Size)\n    file.Read(buffer)\n    return buffer,fileExt[1:]\n}\n')),(0,a.kt)("h2",{id:"12-\u83b7\u53d6\u623f\u6e90\u8be6\u7ec6\u4fe1\u606f"},"12 \u83b7\u53d6\u623f\u6e90\u8be6\u7ec6\u4fe1\u606f"),(0,a.kt)("p",null,"\u83b7\u53d6\u623f\u5c4b\u8be6\u7ec6\u4fe1\u606f\u670d\u52a1\uff08\u5546\u54c1\u76f8\u5173\uff09"),(0,a.kt)("h3",{id:"\u521b\u5efa\u547d\u4ee4-3"},"\u521b\u5efa\u547d\u4ee4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'$ micro new --type "srv" sss/GetHouseInfo\n')),(0,a.kt)("h3",{id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-3"},"\u6d41\u7a0b\u4e0e\u63a5\u53e3"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"im",src:r(2726).Z})),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: GET\n#1\u8868\u793a\u623f\u6e90id\nurl:api/v1.0/houses/1\nurl:api/v1.0/houses/:id\n#data:\nno input data\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f",\n  "data": {\n    "house": {\n      "acreage": 80,\n      "address": "\u897f\u4e09\u65d7\u6865\u4e1c",\n      "beds": "2\u53cc\u4eba\u5e8a",\n      "capacity": 3,\n      "comments": [\n        {\n          "comment": "\u8bc4\u8bba\u7684\u5185\u5bb9",\n          "ctime": "2017-11-12 12:30:30",\n          "user_name": "\u8bc4\u8bba\u4eba\u7684\u59d3\u540d"\n        },\n        {\n          "comment": "\u8bc4\u8bba\u7684\u5185\u5bb9",\n          "ctime": "2017-11-12 12:30:30",\n          "user_name": "\u8bc4\u8bba\u4eba\u7684\u59d3\u540d"\n        },\n        {\n          "comment": "\u8bc4\u8bba\u7684\u5185\u5bb9",\n          "ctime": "2017-11-12 12:30:30",\n          "user_name": "\u8bc4\u8bba\u4eba\u7684\u59d3\u540d"\n        }\n      ],\n      "deposit": 200,\n      "facilities": [9,11,13,16,19,20,21,23],\n      "hid": 1,\n      "img_urls": [\n        "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJY-AL3m8AAS8K2x8TDE052.jpg",\n        "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJZmAYqGWAAaInSze-cQ230.jpg"\n      ],\n      "max_days": 30,\n      "min_days": 1,\n      "price": 100,\n      "room_count": 2,\n      "title": "\u4e0a\u5965\u4e16\u7eaa\u4e2d\u5fc3",\n      "unit": "3\u5ba43\u5385",\n      "user_avatar": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png",\n      "user_id": 1,\n      "user_name": "Panda"\n    },\n    "user_id": 1\n  }\n}\n\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h3",{id:"\u670d\u52a1\u7aef\u5b9e\u73b0-3"},"\u670d\u52a1\u7aef\u5b9e\u73b0"),(0,a.kt)("p",null,"\u521b\u5efa\u670d\u52a1\uff0c\u7136\u540e\u6839\u636e\u63a5\u53e3\u5b9a\u4e49\uff0c\u4fee\u6539proto\u6587\u4ef6\uff0cproto\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'syntax = "proto3";\n\npackage go.micro.srv.getHouseDetail;\n\nservice GetHouseDetail {\n    rpc Call(Request) returns (Response) {}\n}\n\n\nmessage Request {\n    int32 houseId = 1;\n}\n\nmessage Response {\n    string errno = 1;\n    string errmsg = 2;\n    data data = 3;\n}\n\nmessage data{\n    houseInfo house = 1;\n    int32 user_id = 2;\n}\n\nmessage houseInfo {\n    int32 acreage = 1;\n    string address = 2;\n    string beds = 3;\n    int32 capacity = 4;\n    repeated commentInfo comments = 5;\n    int32 deposit = 6;\n    repeated int32 facilities = 7;\n    int32 hid = 8;\n    repeated string img_urls = 9;\n    int32 max_days = 10;\n    int32 min_days = 11;\n    int32 price = 12;\n    int32 room_count = 13;\n    string title = 14;\n    string unit = 15;\n    string user_avatar = 16;\n    int32 user_id = 17;\n    string user_name = 18;\n}\n\nmessage commentInfo{\n    string comment = 1;\n    string ctime = 2;\n    string user_name = 3;\n}\n')),(0,a.kt)("p",null,"\u4fee\u6539main.go\u6587\u4ef6\uff0c\u7136\u540e\u53bbhander\u4e2d\u5b9e\u73b0\u5177\u4f53\u4e1a\u52a1\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'    //\u4eceredis\u6570\u636e\u5e93\u4e2d\u83b7\u53d6\u6570\u636e\n    var data getHouseDetail.Data\n    redisConn := model.InitRedis().Get()\n    houseBuffer, _ := redis.Bytes(redisConn.Do("get", "houseId_"+strconv.Itoa(int(req.HouseId))))\n    if len(houseBuffer) == 0 {\n        //\u5982\u679c\u67e5\u4e0d\u5230\u6570\u636e,\u5c31\u4ece\u6570\u636e\u5e93\u83b7\u53d6\n        // \u83b7\u53d6\u6570\u636e\u5e93\u5b9e\u4f8b\n        db, err := model.InitDb()\n        //\u628a\u5177\u4f53\u7684\u64cd\u4f5c\u5c01\u88c5\u6210\u51fd\u6570\n        house, orders, orderUsers, user, facs, imgs, err := model.GetDetail(db, req.HouseId)\n        if err != nil {\n            return err\n        }\n\n        //\u83b7\u53d6\u8bc4\u8bba\u6570\u636e\n        var comments []*getHouseDetail.CommentInfo\n\n        for k, v := range orders {\n            var commment getHouseDetail.CommentInfo\n            commment.Ctime = v.UpdatedAt.Format("2006:01:02 15:04:05")\n            commment.UserName = orderUsers[k].Name\n            commment.Comment = v.Comment\n\n            comments = append(comments, &commment)\n        }\n\n        //\u83b7\u53d6\u5bb6\u5177\u6570\u636e\n        var fids []int32\n        for _, v := range facs {\n            fids = append(fids, int32(v.ID))\n        }\n\n        //\u83b7\u53d6\u56fe\u7247\n        var imgPaths []string\n        imgPaths = append(imgPaths, house.Index_image_url)\n        for _, v := range imgs {\n            imgPaths = append(imgPaths, v.Url)\n        }\n\n        //\u8bbe\u7f6e\u8fd4\u56de\u6570\u636e\n        var houseInfo getHouseDetail.HouseInfo\n        houseInfo.Acreage = int32(house.Acreage)\n        houseInfo.Address = house.Address\n        houseInfo.Beds = house.Beds\n        houseInfo.Capacity = int32(house.Capacity)\n        houseInfo.Comments = comments\n        houseInfo.Deposit = int32(house.Deposit)\n        houseInfo.Facilities = fids\n        houseInfo.Hid = int32(house.ID)\n        houseInfo.ImgUrls = imgPaths\n        houseInfo.MinDays = int32(house.Min_days)\n        houseInfo.MaxDays = int32(house.Max_days)\n        houseInfo.Price = int32(house.Price)\n        houseInfo.RoomCount = int32(house.Room_count)\n        houseInfo.Title = house.Title\n        houseInfo.Unit = house.Unit\n        houseInfo.UserAvatar = user.Avatar_url\n        houseInfo.UserId = int32(house.UserId)\n        houseInfo.UserName = user.Name\n\n        data.House = &houseInfo\n        data.UserId = int32(user.ID)\n\n        //\u628a\u67e5\u8be2\u5230\u7684\u6570\u636e\u5b58\u50a8\u5230redis\u4e2d\n        buffer,err := json.Marshal(data)\n        if err != nil {\n            return err\n        }\n\n        redisConn.Do("set","houseId_"+strconv.Itoa(int(house.ID)),buffer)\n    }else {\n        //\u5982\u679c\u67e5\u5230\u6570\u636e,\u5c31\u76f4\u63a5\u89e3\u6790\u6570\u636e\n        err := json.Unmarshal(houseBuffer,data)\n        if err != nil {\n            return err\n        }\n    }\n\n    //\u8fd4\u56de\u6570\u636e\n    rsp.Errno = utils.RECODE_OK\n    rsp.Errmsg = utils.RecodeText(utils.RECODE_OK)\n    rsp.Data = &data\n    return nil\n')),(0,a.kt)("p",null,"model\u4e2d\u5c01\u88c5\u7684\u51fd\u6570\u5177\u4f53\u5185\u5bb9\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'//\u6839\u636e\u623f\u5c4bid\u83b7\u53d6\u623f\u5c4b\u4fe1\u606f,\u83b7\u53d6\u8bc4\u8bba,\u7528\u6237\u4fe1\u606f,\u5bb6\u5177\u4fe1\u606f,\u623f\u5c4b\u56fe\u7247\nfunc GetDetail(db*gorm.DB,houseId int32)(House,[]OrderHouse,[]User,User,[]Facility,[]HouseImage,error){\n    var house House\n    var orders []OrderHouse\n    var orderUsers []User\n    var user User\n    var facs []Facility\n    var imgs []HouseImage\n\n\n    house.ID = uint(houseId)\n    err := db.Where(&house).First(&house).Error\n    if err != nil {\n        return house,orders,orderUsers,user,facs,imgs,err\n    }\n\n    //\u83b7\u53d6\u8bc4\u8bba\u4fe1\u606f\n    err = db.Model(&house).Related(&orders).Error\n    if err != nil {\n        return house,orders,orderUsers,user,facs,imgs,err\n    }\n\n    //\u83b7\u53d6\u8bc4\u8bba\u7528\u6237\u4fe1\u606f\n    for _,v := range orders{\n        var orderUser User\n        err := db.Model(&v).Related(&orderUser).Error\n        if err != nil {\n            return house,orders,orderUsers,user,facs,imgs,err\n        }\n        orderUsers = append(orderUsers,orderUser)\n    }\n\n    //\u83b7\u53d6\u7528\u6237\u4fe1\u606f\n    err = db.Model(&house).Related(&user).Error\n    if err != nil {\n        return house,orders,orderUsers,user,facs,imgs,err\n    }\n\n    //\u83b7\u53d6\u5bb6\u5177\u4fe1\u606f\n    err = db.Model(&house).Related(&facs,"Facilities").Error\n    if err != nil {\n        return house,orders,orderUsers,user,facs,imgs,err\n    }\n\n    //\u83b7\u53d6\u623f\u5c4b\u56fe\u7247\n    err = db.Model(&house).Related(&imgs).Error\n    if err != nil {\n        return house,orders,orderUsers,user,facs,imgs,err\n    }\n\n    return house,orders,orderUsers,user,facs,imgs,nil\n}\n')),(0,a.kt)("h3",{id:"web\u7aef\u5b9e\u73b0-3"},"web\u7aef\u5b9e\u73b0"),(0,a.kt)("p",null,"\u6839\u636e\u63a5\u53e3\u5b9a\u4e49\uff0c\u7ed9\u8bf7\u6c42\u8bbe\u7f6e\u5bf9\u5e94\u8def\u7531\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'r1.GET("/houses/:id",controller.GetHouseInfo)\n')),(0,a.kt)("p",null,"\u7136\u540e\u53bbcontroller\u4e2d\u5b9e\u73b0\u5bf9\u5e94\u4e1a\u52a1\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'//\u83b7\u53d6\u623f\u5c4b\u8be6\u7ec6\u4fe1\u606f\nfunc GetHouseInfo(ctx*gin.Context){\n    //\u83b7\u53d6\u6570\u636e\n    errResp := make(map[string]interface{})\n    houseId := ctx.Param("id")\n\n    //\u6821\u9a8c\u6570\u636e\n    id,err := strconv.Atoi(houseId)\n    if err != nil {\n        errResp["errno"] = utils.RECODE_REQERR\n        errResp["errmsg"] = utils.RecodeText(utils.RECODE_REQERR)\n        ctx.JSON(200,errResp)\n        return\n    }\n\n    //\u8c03\u7528\u8fdc\u7a0b\u670d\u52a1\n    grpcService := utils.GetGrpcService()\n    client := getDetail.NewGetHouseDetailService(utils.GetDetail,grpcService.Client())\n    resp,err := client.Call(context.TODO(),&getDetail.Request{HouseId:int32(id)})\n    \n    //\u8fd4\u56de\u6570\u636e\n    if err != nil {\n        fmt.Println(err)\n        errResp["errno"] = utils.RECODE_SERVERERR\n        errResp["errmsg"] = utils.RecodeText(utils.RECODE_SERVERERR)\n        ctx.JSON(200,errResp)\n        return\n    }\n\n    ctx.JSON(200,resp)\n\n}\n')),(0,a.kt)("h2",{id:"13-\u83b7\u53d6\u9996\u9875\u52a8\u753b\u56fe\u7247"},"13 \u83b7\u53d6\u9996\u9875\u52a8\u753b\u56fe\u7247"),(0,a.kt)("p",null,"\u83b7\u53d6\u9996\u9875\u8f6e\u64ad\u56fe\u7247\u670d\u52a1\uff08\u9996\u9875\u76f8\u5173\uff09"),(0,a.kt)("h3",{id:"\u521b\u5efa\u547d\u4ee4-4"},"\u521b\u5efa\u547d\u4ee4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'$ micro new --type "srv" sss/GetIndex\n')),(0,a.kt)("h3",{id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-4"},"\u6d41\u7a0b\u4e0e\u63a5\u53e3"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"im",src:r(3661).Z})),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'#Request:\nmethod: GET\nurl:api/v1.0/house/index\n#data:\nno input data\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f",\n  "data": {\n        "houses": [\n      {\n        "house_id":    this.Id,\n        "title":       this.Title,\n        "price":       this.Price,\n        "area_name":   this.Area.Name,\n        "img_url":     utils.AddDomain2Url(this.Index_image_url),\n        "room_count":  this.Room_count,\n        "order_count": this.Order_count,\n        "address":     this.Address,\n        "user_avatar": utils.AddDomain2Url(this.User.Avatar_url),\n        "ctime":       this.Ctime.Format("2006-01-02 15:04:05"),\n    },\n      {\n        "house_id":    this.Id,\n        "title":       this.Title,\n        "price":       this.Price,\n        "area_name":   this.Area.Name,\n        "img_url":     utils.AddDomain2Url(this.Index_image_url),\n        "room_count":  this.Room_count,\n        "order_count": this.Order_count,\n        "address":     this.Address,\n        "user_avatar": utils.AddDomain2Url(this.User.Avatar_url),\n        "ctime":       this.Ctime.Format("2006-01-02 15:04:05"),\n    }\n    ],\n   \n  }\n}\n\n\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h2",{id:"14-\u641c\u7d22\u623f\u6e90"},"14 \u641c\u7d22\u623f\u6e90"),(0,a.kt)("p",null,"\u83b7\u53d6\uff08\u641c\u7d22\uff09\u623f\u6e90\u670d\u52a1\uff08\u5546\u54c1\u76f8\u5173\uff09"),(0,a.kt)("h3",{id:"\u521b\u5efa\u547d\u4ee4-5"},"\u521b\u5efa\u547d\u4ee4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'$ micro new --type "srv" sss/GetHouses\n')),(0,a.kt)("h3",{id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-5"},"\u6d41\u7a0b\u4e0e\u63a5\u53e3"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"im",src:r(1499).Z})),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: GET\n#adi\u8868\u793a\u5730\u533a\u7f16\u53f7\n#sd\u8868\u793a\u8d77\u59cb\u65e5\u671f\n#ed\u8868\u793a\u7ed3\u675f\u65e5\u671f\n#sk\u8868\u793a\u67e5\u8be2\u65b9\u5f0f\n#p\u8868\u793a\u9875\u7801\nurl:api/v1.0/houses?aid=5&sd=2017-11-12&ed=2017-11-30&sk=new\n#data:\nno input data\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f",\n  "data": {\n    "current_page": 1,\n    "houses": [\n      {\n        "address": "\u897f\u4e09\u65d7\u6865\u4e1c",\n        "area_name": "\u660c\u5e73\u533a",\n        "ctime": "2017-11-06 11:16:24",\n        "house_id": 1,\n        "img_url": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJY-AL3m8AAS8K2x8TDE052.jpg",\n        "order_count": 0,\n        "price": 100,\n        "room_count": 2,\n        "title": "\u4e0a\u5965\u4e16\u7eaa\u4e2d\u5fc313\u53f7\u697c",\n        "user_avatar": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png"\n      },\n      {\n        "address": "\u897f\u4e09\u65d7\u6865\u4e1c",\n        "area_name": "\u660c\u5e73\u533a",\n        "ctime": "2017-11-06 11:16:24",\n        "house_id": 1,\n        "img_url": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJY-AL3m8AAS8K2x8TDE052.jpg",\n        "order_count": 0,\n        "price": 100,\n        "room_count": 2,\n        "title": "\u4e0a\u5965\u4e16\u7eaa\u4e2d\u5fc318\u53f7\u697c",\n        "user_avatar": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png"\n        }\n    ],\n    "total_page": 1\n  }\n}\n\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h2",{id:"15-\u53d1\u5e03\u8ba2\u5355"},"15 \u53d1\u5e03\u8ba2\u5355"),(0,a.kt)("p",null,"\u53d1\u9001\uff08\u53d1\u5e03\uff09\u8ba2\u5355\u670d\u52a1\uff08\u8ba2\u5355\u76f8\u5173\uff09"),(0,a.kt)("h3",{id:"\u521b\u5efa\u547d\u4ee4-6"},"\u521b\u5efa\u547d\u4ee4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'$ micro new --type "srv" sss/PostOrders\n')),(0,a.kt)("h3",{id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-6"},"\u6d41\u7a0b\u4e0e\u63a5\u53e3"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"im",src:r(2915).Z})),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: POST\nurl:api/v1.0/orders\n#data:\n{\n  "house_id": "1",\n  "start_date": "2017-11-11 21:23:49",\n  "end_date": "2017-11-12 21:23:49",\n}\n\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f",\n  "data": {\n    "order_id":"1"\n  }\n}\n\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h2",{id:"16-\u8bf7\u6c42\u67e5\u770b\u623f\u4e1c\u79df\u5ba2\u8ba2\u5355\u4fe1\u606f"},"16 \u8bf7\u6c42\u67e5\u770b\u623f\u4e1c/\u79df\u5ba2\u8ba2\u5355\u4fe1\u606f"),(0,a.kt)("p",null,"\u83b7\u53d6\u623f\u4e1c/\u79df\u6237\u8ba2\u5355\u4fe1\u606f\u670d\u52a1\uff08\u8ba2\u5355\u76f8\u5173\uff09"),(0,a.kt)("h3",{id:"\u521b\u5efa\u547d\u4ee4-7"},"\u521b\u5efa\u547d\u4ee4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'$ micro new --type "srv" sss/GetUserOrder\n')),(0,a.kt)("h3",{id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-7"},"\u6d41\u7a0b\u4e0e\u63a5\u53e3"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"im",src:r(1848).Z})),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: GET\nurl:api/v1.0/user/orders?role=custom \u5907\u6ce8:role=custom\u4e3a\u79df\u5ba2\u67e5\u770b\u8ba2\u5355\u4fe1\u606f\nurl:api/v1.0/user/orders?role=landlord \u5907\u6ce8:role=landlord\u4e3a\u623f\u4e1c\u67e5\u770b\u88ab\u9884\u5b9a\u8ba2\u5355\u4fe1\u606f\n#data:\nno input data\n\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f",\n  "data": {\n    "orders": [\n      {\n        "amount": 200,\n        "comment": "\u54c8\u54c8\u62d2\u63a5",\n        "ctime": "2017-11-11 21:23:49",\n        "days": 2,\n        "end_date": "2017-11-29 16:00:00",\n        "img_url": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJY-AL3m8AAS8K2x8TDE052.jpg",\n        "order_id": 3,\n        "start_date": "2017-11-28 16:00:00",\n        "status": "REJECTED",//WAIT_ACCPET,WAIT_COMMENT,REJECTED,COMPLETE,CANCELED\n        "title": "\u4e0a\u5965\u4e16\u7eaa\u4e2d\u5fc3"\n      },\n      {\n        "amount": 1500,\n        "comment": "",\n        "ctime": "2017-11-11 01:32:10",\n        "days": 15,\n        "end_date": "2017-11-24 16:00:00",\n        "img_url": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJY-AL3m8AAS8K2x8TDE052.jpg",\n        "order_id": 2,\n        "start_date": "2017-11-10 16:00:00",\n        "status": "WAIT_COMMENT",\n        "title": "\u4e0a\u5965\u4e16\u7eaa\u4e2d\u5fc3"\n      },\n      {\n        "amount": 300,\n        "comment": "",\n        "ctime": "2017-11-10 01:46:00",\n        "days": 3,\n        "end_date": "2017-11-11 16:00:00",\n        "img_url": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJY-AL3m8AAS8K2x8TDE052.jpg",\n        "order_id": 1,\n        "start_date": "2017-11-09 16:00:00",\n        "status": "WAIT_COMMENT",\n        "title": "\u4e0a\u5965\u4e16\u7eaa\u4e2d\u5fc3"\n      }\n    ]\n  }\n}\n\n\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h2",{id:"17-\u623f\u4e1c\u540c\u610f\u62d2\u7edd\u8ba2\u5355"},"17 \u623f\u4e1c\u540c\u610f/\u62d2\u7edd\u8ba2\u5355"),(0,a.kt)("p",null,"\u66f4\u65b0\u623f\u4e1c\u540c\u610f/\u62d2\u7edd\u8ba2\u5355\uff08\u8ba2\u5355\u76f8\u5173\uff09"),(0,a.kt)("h3",{id:"\u521b\u5efa\u547d\u4ee4-8"},"\u521b\u5efa\u547d\u4ee4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'$ micro new --type "srv" sss/PutOrders\n')),(0,a.kt)("h3",{id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-8"},"\u6d41\u7a0b\u4e0e\u63a5\u53e3"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"im",src:r(950).Z})),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: PUT\n#4\u8868\u793a\u8ba2\u5355id\nurl:api/v1.0/orders/4/status\nurl:api/v1.0/orders/:id/status\n#data:\n#"accept"\u8868\u793a\u63a5\u53d7\n#"reject"\u8868\u793a\u62d2\u7edd\n{action: "accept"}   \n\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f"\n}\n\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')),(0,a.kt)("h2",{id:"18-\u7528\u6237\u8bc4\u4ef7\u8ba2\u5355\u4fe1\u606f"},"18 \u7528\u6237\u8bc4\u4ef7\u8ba2\u5355\u4fe1\u606f"),(0,a.kt)("p",null,"\u66f4\u65b0\u7528\u6237\u8bc4\u4ef7\u8ba2\u5355\u4fe1\u606f\uff08\u8ba2\u5355\u76f8\u5173\uff09"),(0,a.kt)("h3",{id:"\u521b\u5efa\u547d\u4ee4-9"},"\u521b\u5efa\u547d\u4ee4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'$ micro new --type "srv" sss/PutComment \n')),(0,a.kt)("h3",{id:"\u6d41\u7a0b\u4e0e\u63a5\u53e3-9"},"\u6d41\u7a0b\u4e0e\u63a5\u53e3"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"im",src:r(2876).Z})),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'#Request:\nmethod: PUT\n#2\u8868\u793a\u8ba2\u5355id0\nurl:api/v1.0/orders/2/comment \nurl:api/v1.0/orders/:id/comment \n#data:\n{\n    order_id: "2", \n    comment: "\u70c2\u623f\u5b50\uff01"\n}\n#Response\n#\u8fd4\u56de\u6210\u529f\uff1a\n\n{\n  "errno": "0",\n  "errmsg": "\u6210\u529f"\n}\n\n#\u8fd4\u56de\u5931\u8d25\uff1a\n{\n    "errno": "400x",   //\u72b6\u6001\u7801\n    "errmsg":"\u72b6\u6001\u9519\u8bef\u4fe1\u606f"\n}\n')))}c.isMDXComponent=!0},9538:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1542889467165-6c6782e029eb89599f9e534356dc521e.jpg"},8738:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543150684587-703fe7d8e03e8a8d1b264bb429939a75.jpg"},1858:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543150703766-6fdb20b17eed1f44c50274a79c07878c.jpg"},8437:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543151932045-193a2bb1700eb1f716d819e9101d0583.jpg"},3213:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543152066379-bc3a1aa02fd44dc9abdd792bc28e9cf0.jpg"},2061:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543152217047-3f9e1b6b4803d5cc35c1c5f2d20ba44c.jpg"},8022:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543152417782-22cc0bb9de616f0e5b0ce8134b2953f7.jpg"},9124:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543152506873-220fb2efb8419300ec935eed850d6229.jpg"},3849:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543153060818-3b8775d19131e8c855e1f4f2fedc6633.jpg"},901:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543153360870-47aee0c3b05843dcf3cd354b7f87e041.jpg"},2625:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543153464298-ac4ada12131b4b7c930e4fd50a2f97d8.jpg"},2726:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543153705596-bdf39c85f06840740726a690506b54e7.jpg"},3661:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543154107047-8228cf0cb8d3546616b8a9b4a7c617ff.jpg"},1499:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543154391621-271f3a7bdb21a2a57440b32237050a82.jpg"},2915:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543154867892-9fe10615c22db408a1c5de56c7b3e369.jpg"},1848:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543155051108-61ca66d4262066fa7fdc135e9aae53bc.jpg"},950:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543155208535-e9883bb0e73636d39fa32b7c21cba962.jpg"},2876:function(e,n,r){n.Z=r.p+"assets/images/clip_image002-1543156498014-d3ba348603ca8ee9c5c0e9dd23e153d4.jpg"}}]);